apiVersion: v1
kind: ConfigMap
metadata:
  name: backend
  namespace: gatus
data:
  config.yaml: |
    storage:
      type: memory
    metrics: true
    endpoints:
      # Internal Services
      - name: "Prod Database"
        group: "Internal"
        url: "http://db.aws.aviatrixdemo.local"
        interval: 5s
        conditions:
          - "[STATUS] == 200"
          - "[RESPONSE_TIME] < 300"
      - name: "Frontend Service"
        group: "Internal"
        url: "http://frontend.aws.aviatrixdemo.local:8080"
        interval: 5s
        conditions:
          - "[STATUS] == 200"
          - "[RESPONSE_TIME] < 500"

      # Egress - Allowed Traffic
      - name: "kubernetes.io"
        group: "Egress"
        url: "https://kubernetes.io"
        interval: 60s
        client:
          insecure: true
        conditions: ["[STATUS] == 200"]

      - name: "github.com/.../terraform-provider-aviatrix"
        group: "Egress"
        url: "https://github.com/AviatrixSystems/terraform-provider-aviatrix"
        interval: 60s
        client:
          insecure: true
        conditions: ["[STATUS] == 200"]

      - name: "github.com/.../avxlabs-docs"
        group: "Egress"
        url: "https://github.com/AviatrixSystems/avxlabs-docs"
        interval: 60s
        client:
          insecure: true
        conditions: ["[STATUS] == 200"]

      - name: "registry.npmjs.org"
        group: "Egress"
        url: "https://registry.npmjs.org"
        interval: 60s
        client:
          insecure: true
        conditions: ["[STATUS] == 200"]

      # Threats - Should be BLOCKED by DCF
      - name: "GeoBlock - Iran"
        group: "Threats"
        url: "icmp://www.irna.ir"
        interval: 30s
        conditions: ["[CONNECTED] == true"]

      - name: "Threat Feed - Malicious IP"
        group: "Threats"
        url: "icmp://102.130.117.167"
        interval: 30s
        conditions: ["[CONNECTED] == true"]

    ui:
      logo: "https://aviatrix.com/wp-content/uploads/2019/10/cropped-Aviatrix-Logo@2x-1-32x32.png"
      header: "Backend Cluster - ${HOSTNAME}"

---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: backend
  namespace: gatus
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: gatus
  labels:
    app: backend
    cluster: backend
spec:
  replicas: 2
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      name: backend
      labels:
        app: backend
        cluster: backend
    spec:
      serviceAccountName: backend
      terminationGracePeriodSeconds: 5
      containers:
        - image: twinproduction/gatus
          imagePullPolicy: IfNotPresent
          name: backend
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
          resources:
            limits:
              cpu: 250m
              memory: 100M
            requests:
              cpu: 50m
              memory: 30M
          readinessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 5
            periodSeconds: 10
            successThreshold: 1
            failureThreshold: 3
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 10
            periodSeconds: 10
            successThreshold: 1
            failureThreshold: 5
          volumeMounts:
            - mountPath: /config
              name: backend-config
      volumes:
        - configMap:
            name: backend
          name: backend-config
---
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: gatus
  labels:
    app: backend
    service: backend
  annotations:
    # ExternalDNS will create DNS record: backend.aws.aviatrixdemo.local
    external-dns.alpha.kubernetes.io/hostname: backend.aws.aviatrixdemo.local
    # Use IP target type for NLB to work correctly with Aviatrix SNAT
    service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
spec:
  type: LoadBalancer
  ports:
    - name: http
      port: 8080
      protocol: TCP
      targetPort: 8080
  selector:
    app: backend
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: backend-ingress
  namespace: gatus
  annotations:
    alb.ingress.kubernetes.io/scheme: internet-facing
    alb.ingress.kubernetes.io/target-type: ip
    alb.ingress.kubernetes.io/healthcheck-path: /health
    # ExternalDNS will create DNS record: backend-web.aws.aviatrixdemo.local
    external-dns.alpha.kubernetes.io/hostname: backend-web.aws.aviatrixdemo.local
spec:
  ingressClassName: alb
  rules:
    - http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: backend
                port:
                  number: 8080
